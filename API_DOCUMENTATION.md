# CDSS API & Data Flow Documentation

## 1. Overview
The CDSS (Clinical Decision Support System) uses a hybrid architecture combining **Next.js Route Handlers (REST APIs)** for client-side interactions and **Server Actions/Direct Queries** for data-intensive dashboard views.

- **Primary Logic**: Rule-based MSK heuristic engine.
- **AI Layer**: Mistral AI for preliminary qualitative analysis.
- **Persistence**: MongoDB with Mongoose ODM.

### Target Audience & Team Ownership
- **ðŸ‘‘ Samkiell (Lead)**: Core architecture, all dashboard shells, admin UI, AI core logic.
- **ðŸ”¥ Philip (Heavy Full-Stack)**: Core business flows (Assessment â†’ Diagnosis â†’ Review), Clinician Case View.
- **ðŸŽ¨ Abraham (Frontend)**: Patient-side UI implementation, Settings, Help Center.
- **ðŸ”„ Tobi (Light Full-Stack)**: Clinician support pages (Patient list, Messages).
- **ðŸ§± Robert (Backend)**: Profile APIs, Stats, Data Contracts.

---

## 2. Page & Route Mapping
This section defines the ownership and logic for every route in the system.

### 2.1 Patient Routes (Dashboard & UI)
| Route | Owner | Purpose | API / Logic |
| :--- | :--- | :--- | :--- |
| `/patient/dashboard` | Samkiell | Overview & Stats | `db.DiagnosisSession`, `db.Appointment` |
| `/patient/assessment/**` | Philip | Assessment Wizard | `/api/assessment/submit` |
| `/patient/progress` | Abraham | Recovery Charts | Heuristic Engine Output UI |
| `/patient/messages` | Philip | Communication | (Planned) WebSockets or Polling |
| `/patient/settings` | Abraham | User Profile | `/api/patients/profile` |

### 2.2 Clinician Routes (Core & Support)
| Route | Owner | Purpose | API / Logic |
| :--- | :--- | :--- | :--- |
| `/clinician/dashboard` | Samkiell | Patient Queue | `getAssignedCases` Service |
| `/clinician/cases/[id]` | Philip | Case Review | `GET /api/diagnosis/[id]` |
| `/clinician/patients` | Tobi | CRM / Patient List | `/api/users?role=PATIENT` |
| `/clinician/guided-diagnostic`| Philip | Assisted Physical Exam | Heuristic Engine Logic |
| `/clinician/treatment-planner`| Philip | Recovery Planning | `db.TreatmentPlan` CRUD |

### 2.3 Admin Routes
| Route | Owner | Purpose | API / Logic |
| :--- | :--- | :--- | :--- |
| `/admin/**` | Samkiell | System Mgt | `src/app/actions/admin.js` |

---

## 3. API Specification

### 3.1 Auth & Identity
#### `POST /api/otp/send`
- **Request**: `{ email, firstName?, lastName?, password? }`
- **Logic**: Used for both login verification and account initialization.

#### `POST /api/patients/profile` (Owned by Robert)
- **Method**: `GET / PATCH`
- **Purpose**: Fetch or update patient demographic data.

#### `GET /api/users?role=PATIENT` (Owned by Robert)
- **Purpose**: Lists all registered patients for clinician/admin views.

### 3.2 Clinical Endpoints
#### `POST /api/assessment/submit`
- **Logic**: Calls Mistral AI Agent â†’ Persists `DiagnosisSession` â†’ Creates `CaseFile`.

#### `PATCH /api/diagnosis/[id]` (Owned by Robert)
- **Goal**: Finalize clinician review and confirm diagnosis.

#### `GET /api/clinician/stats` (Owned by Robert)
- **Purpose**: Aggregated data for dashboard widgets (active cases, pending reviews).

---

## 4. Operational Governance (Hard Boundaries)

### 4.1 Dashboard Shell Authority
To maintain UI consistency and role enforcement, the **Dashboard Shells** (Sidebar, TopNav, Layout logic) are restricted.
- **Protected Controllers**: `Samkiell` & `Philip` only.
- **Rule**: No direct modifications to layout files by other team members without PR approval.

### 4.2 PR & Integration Workflow
1. **Feature Isolation**: One branch per developer per feature.
2. **Review Tier**: All core logic changes (Heuristic/AI) must be reviewed by Samkiell.
3. **Parity**: Ensure patient and clinician experiences share component libraries where medically applicable.

---

## 5. Data Models & Contracts
### 5.1 DiagnosisSession
The source of truth for MSK assessments. Stores `symptomData` (Heuristic input) and `aiAnalysis` (LLM output).

### 5.2 CaseFile
The administrative link between a patient's session and a clinician assignment.

### 5.3 TreatmentPlan
Iterative recovery schedules, including sets/reps and daily goals.
---

## 7. Appendix

### 7.1 Project Milestones
- **Current Cycle Deadline**: Thursday, January 30th, 2026.
- **Review Frequency**: Physical meetings held weekly for integration sync.

### 7.2 Glossary
- **Temporal Diagnosis**: An immediate, rule-based clinical assessment generated by the Heuristic Engine.
- **Provisional AI Analysis**: Qualitative reasoning provided by the LLM agent (requires clinician validation).
- **Hard Shell**: Components (Sidebar/Nav) protected by lead developers to ensure role-based enforcement.
- **VAS Scale**: Visual Analogue Scale used for subjective pain measurement in assessments.
